<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Files - MR. B Dental Lab</title>
  <link rel="stylesheet" href="./styles/main.css">
  <style>
    .upload-container {
      max-width: 800px;
      margin: 50px auto;
      padding: 30px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .upload-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .upload-header h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .upload-area {
      border: 3px dashed #3498db;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      background: #f8f9fa;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: #2980b9;
      background: #e3f2fd;
    }

    .upload-area.dragover {
      border-color: #27ae60;
      background: #e8f5e8;
    }

    .upload-icon {
      font-size: 48px;
      color: #3498db;
      margin-bottom: 20px;
    }

    .upload-text {
      color: #666;
      margin-bottom: 20px;
    }

    .file-input {
      display: none;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: transform 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .auth-section {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      border-radius: 10px;
      background: #f1f3f4;
    }

    .progress-container {
      margin-top: 30px;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      width: 0%;
      transition: width 0.3s ease;
    }

    .file-list {
      margin-top: 20px;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }

    .file-item.success {
      border-left-color: #27ae60;
    }

    .file-item.error {
      border-left-color: #e74c3c;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #3498db;
      text-decoration: none;
      font-weight: 500;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="upload-container">
    <a href="index.html" class="back-link">‚Üê Back to Home</a>

    <div class="upload-header">
      <h1>Upload Files to Google Drive</h1>
      <p>Securely upload your files to our Google Drive folder</p>
    </div>

    <div class="auth-section">
      <div id="auth-status">
        <p>Please authenticate with Google Drive to upload files</p>
        <button id="auth-btn" class="btn">Connect to Google Drive</button>
        <button id="signout-btn" class="btn" style="display: none;">Sign Out</button>
        <button id="account-btn" class="btn" style="display: none;">Choose Google Account</button>
      </div>
      <div id="debug-info" style="margin-top: 15px; font-size: 12px; color: #666; display: none;">
        <p>Debug Info:</p>
        <ul id="debug-list"></ul>
      </div>
    </div>

    <div id="upload-section" style="display: none;">
      <div class="upload-area" id="upload-area">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text">
          <p><strong>Drag and drop files here</strong></p>
          <p>or</p>
          <button class="btn" onclick="document.getElementById('file-input').click()">Choose Files</button>
        </div>
        <input type="file" id="file-input" class="file-input" multiple>
      </div>

      <div class="progress-container" id="progress-container">
        <h3>Upload Progress</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div id="progress-text">0% Complete</div>
      </div>

      <div class="file-list" id="file-list"></div>

      <div class="status" id="status"></div>
    </div>

    <!-- Setup Instructions -->
    <div
      style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #17a2b8;">
      <h3 style="color: #17a2b8; margin-top: 0;">Setup Instructions</h3>
      <p><strong>If the "Connect to Google Drive" button doesn't work, follow these steps:</strong></p>

      <ol style="line-height: 1.8;">
        <li><strong>Run from a local server (required):</strong>
          <ul style="margin-top: 5px;">
            <li>Python: <code>python -m http.server 8080</code></li>
            <li>Node.js: <code>npx http-server -p 8080</code></li>
            <li>PHP: <code>php -S localhost:8080</code></li>
          </ul>
        </li>

        <li><strong>Access the page at:</strong> <code>http://localhost:8080/upload.html</code></li>

        <li><strong>Google Cloud Console Setup:</strong>
          <ul style="margin-top: 5px;">
            <li>Go to <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a></li>
            <li>Enable the Google Drive API</li>
            <li>Create OAuth 2.0 credentials (Web application)</li>
            <li>Add <code>http://localhost:8080</code> to "Authorized JavaScript origins"</li>
            <li>Download credentials and save as <code>secret.json</code></li>
          </ul>
        </li>

        <li><strong>OAuth Consent Screen:</strong>
          <ul style="margin-top: 5px;">
            <li>Configure the OAuth consent screen</li>
            <li>Add your email as a test user (if testing)</li>
            <li>Add the scope: <code>https://www.googleapis.com/auth/drive.file</code></li>
          </ul>
        </li>
      </ol>

      <p style="margin-bottom: 0;"><strong>Common Issues:</strong></p>
      <ul style="line-height: 1.6;">
        <li>403 Error: Check OAuth consent screen and test users</li>
        <li>Popup blocked: Allow popups for this site</li>
        <li>Config not loading: Make sure secret.json is accessible via HTTP</li>
      </ul>
    </div>
  </div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    let isGapiLoaded = false;
    let isSignedIn = false;
    let uploadFolder = null;

    // Load configuration from secret.json
    let config = {};

    function addDebugInfo(message) {
      const debugList = document.getElementById('debug-list');
      const debugInfo = document.getElementById('debug-info');
      const li = document.createElement('li');
      li.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      debugList.appendChild(li);
      debugInfo.style.display = 'block';
      console.log('DEBUG:', message);
    }

    async function loadConfig() {
      try {
        addDebugInfo('Loading configuration from secret.json...');
        const response = await fetch('./secret.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        config = await response.json();
        addDebugInfo('Configuration loaded successfully');
        addDebugInfo(`Client ID: ${config.web.client_id.substring(0, 20)}...`);
        return true;
      } catch (error) {
        console.error('Error loading configuration:', error);
        addDebugInfo(`Error loading config: ${error.message}`);
        showStatus('Error loading configuration. Make sure you are running from a local server (not file://) and secret.json is accessible.', 'error');
        return false;
      }
    }

    // Check if we're running from a local server
    function checkServerRequirement() {
      if (window.location.protocol === 'file:') {
        addDebugInfo('ERROR: Running from file:// protocol');
        showStatus('This page must be served from a local server. Please use: python -m http.server 8080 or similar.', 'error');
        return false;
      }
      addDebugInfo(`Running from: ${window.location.origin}`);
      return true;
    }

    // Initialize Google API
    function initializeGapi() {
      addDebugInfo('Loading Google API...');

      gapi.load('auth2:client', async () => {
        try {
          addDebugInfo('Google API loaded, initializing client...');

          await gapi.client.init({
            apiKey: '', // We'll use OAuth2 flow
            clientId: config.web.client_id,
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            scope: 'https://www.googleapis.com/auth/drive.file'
          });

          addDebugInfo('Google API client initialized');
          isGapiLoaded = true;
          const authInstance = gapi.auth2.getAuthInstance();
          isSignedIn = authInstance.isSignedIn.get();

          addDebugInfo(`Initial sign-in status: ${isSignedIn}`);
          updateAuthUI();

          // Listen for sign-in state changes
          authInstance.isSignedIn.listen((signedIn) => {
            addDebugInfo(`Sign-in status changed: ${signedIn}`);
            isSignedIn = signedIn;
            updateAuthUI();
          });

        } catch (error) {
          console.error('Error initializing Google API:', error);
          addDebugInfo(`Google API init error: ${error.message}`);
          showStatus('Error initializing Google API. Please check your credentials and make sure the Google Drive API is enabled.', 'error');
        }
      });
    }

    function updateAuthUI() {
      const authBtn = document.getElementById('auth-btn');
      const signoutBtn = document.getElementById('signout-btn');
      const accountBtn = document.getElementById('account-btn');
      const uploadSection = document.getElementById('upload-section');
      const authStatus = document.querySelector('#auth-status p');

      if (isSignedIn) {
        authBtn.style.display = 'none';
        signoutBtn.style.display = 'inline-block';
        accountBtn.style.display = 'inline-block';
        uploadSection.style.display = 'block';
        authStatus.textContent = 'Connected to Google Drive ‚úì';
        addDebugInfo('User authenticated, creating upload folder...');
        createUploadFolder();
      } else {
        authBtn.style.display = 'inline-block';
        signoutBtn.style.display = 'none';
        accountBtn.style.display = 'none';
        uploadSection.style.display = 'none';
        authStatus.textContent = 'Please authenticate with Google Drive to upload files';
      }
    }

    // Authentication functions
    document.getElementById('auth-btn').addEventListener('click', async () => {
      addDebugInfo('Connect button clicked');

      if (!isGapiLoaded) {
        addDebugInfo('Google API not loaded yet');
        showStatus('Google API is still loading. Please wait a moment and try again.', 'error');
        return;
      }

      try {
        addDebugInfo('Starting sign-in process...');
        const authInstance = gapi.auth2.getAuthInstance();
        const user = await authInstance.signIn();
        addDebugInfo('Sign-in successful');
        isSignedIn = true;
        updateAuthUI();
      } catch (error) {
        console.error('Sign-in error:', error);
        addDebugInfo(`Sign-in error: ${error.error || error.message}`);

        if (error.error === 'popup_blocked_by_browser') {
          showStatus('Popup was blocked. Please allow popups for this site and try again.', 'error');
        } else if (error.error === 'access_denied') {
          showStatus('Access denied. Please grant permission to access Google Drive.', 'error');
        } else {
          showStatus(`Sign-in failed: ${error.error || error.message}. Make sure your Google Cloud Console is properly configured.`, 'error');
        }
      }
    });

    document.getElementById('signout-btn').addEventListener('click', () => {
      if (isGapiLoaded) {
        gapi.auth2.getAuthInstance().signOut().then(() => {
          isSignedIn = false;
          addDebugInfo('User signed out');
          updateAuthUI();
        });
      }
    });

    document.getElementById('account-btn').addEventListener('click', async () => {
      if (isGapiLoaded) {
        try {
          const authInstance = gapi.auth2.getAuthInstance();
          await authInstance.signOut();
          await authInstance.signIn();
          addDebugInfo('Account switched');
        } catch (error) {
          addDebugInfo(`Account switch error: ${error.message}`);
        }
      }
    });

    // Create upload folder in Google Drive
    async function createUploadFolder() {
      try {
        // Check if folder already exists
        const response = await gapi.client.drive.files.list({
          q: "name='MR. B Dental Lab Uploads' and mimeType='application/vnd.google-apps.folder' and trashed=false",
          spaces: 'drive'
        });

        if (response.result.files.length > 0) {
          uploadFolder = response.result.files[0];
          console.log('Using existing upload folder:', uploadFolder.id);
        } else {
          // Create new folder
          const folderResponse = await gapi.client.drive.files.create({
            resource: {
              name: 'MR. B Dental Lab Uploads',
              mimeType: 'application/vnd.google-apps.folder'
            }
          });
          uploadFolder = folderResponse.result;
          console.log('Created new upload folder:', uploadFolder.id);
        }
      } catch (error) {
        console.error('Error creating upload folder:', error);
        showStatus('Error setting up upload folder.', 'error');
      }
    }

    // File upload handling
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    // Drag and drop events
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files);
      uploadFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      uploadFiles(files);
    });

    async function uploadFiles(files) {
      if (!files.length) return;

      const progressContainer = document.getElementById('progress-container');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      const fileList = document.getElementById('file-list');

      progressContainer.style.display = 'block';
      fileList.innerHTML = '';

      let uploadedCount = 0;
      const totalFiles = files.length;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileItem = createFileListItem(file.name, 'uploading');
        fileList.appendChild(fileItem);

        try {
          await uploadSingleFile(file);
          fileItem.classList.remove('uploading');
          fileItem.classList.add('success');
          fileItem.querySelector('.file-status').textContent = 'Uploaded ‚úì';
          uploadedCount++;
        } catch (error) {
          console.error('Upload error:', error);
          fileItem.classList.remove('uploading');
          fileItem.classList.add('error');
          fileItem.querySelector('.file-status').textContent = 'Failed ‚úó';
        }

        // Update progress
        const progress = ((i + 1) / totalFiles) * 100;
        progressFill.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '% Complete';
      }

      // Show final status
      if (uploadedCount === totalFiles) {
        showStatus(`Successfully uploaded ${uploadedCount} file(s)!`, 'success');
      } else {
        showStatus(`Uploaded ${uploadedCount} out of ${totalFiles} files. Some uploads failed.`, 'error');
      }

      // Reset file input
      fileInput.value = '';
    }

    function createFileListItem(fileName, status) {
      const fileItem = document.createElement('div');
      fileItem.className = `file-item ${status}`;
      fileItem.innerHTML = `
                <span class="file-name">${fileName}</span>
                <span class="file-status">${status === 'uploading' ? 'Uploading...' : status}</span>
            `;
      return fileItem;
    }

    async function uploadSingleFile(file) {
      const metadata = {
        name: file.name,
        parents: [uploadFolder.id]
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', file);

      const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;

      const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${accessToken}`
        },
        body: form
      });

      if (!response.ok) {
        throw new Error(`Upload failed: ${response.statusText}`);
      }

      return response.json();
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';

      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 5000);
      }
    }

    // Initialize the application
    async function initApp() {
      addDebugInfo('Starting application...');

      // Check server requirement
      if (!checkServerRequirement()) {
        return;
      }

      // Load configuration
      const configLoaded = await loadConfig();
      if (!configLoaded) {
        return;
      }

      // Initialize Google API
      if (typeof gapi === 'undefined') {
        addDebugInfo('ERROR: Google API script not loaded');
        showStatus('Google API script failed to load. Check your internet connection.', 'error');
        return;
      }

      initializeGapi();
    }

    // Start the app when page loads
    window.addEventListener('load', initApp);

    // Add setup instructions
    function showSetupInstructions() {
      const instructions = `
        SETUP INSTRUCTIONS:
        
        1. Make sure you're running this from a local server:
           - Python: python -m http.server 8080
           - Node.js: npx http-server -p 8080
           - PHP: php -S localhost:8080
        
        2. Access the page at: http://localhost:8080/upload.html
        
        3. Google Cloud Console Setup:
           - Go to console.cloud.google.com
           - Enable Google Drive API
           - Create OAuth 2.0 credentials
           - Add http://localhost:8080 to authorized JavaScript origins
           - Download credentials as secret.json
        
        4. Make sure secret.json is in the same folder as this HTML file
      `;
      console.log(instructions);
    }

    // Call setup instructions on load
    showSetupInstructions();
  </script>
</body>

</html>